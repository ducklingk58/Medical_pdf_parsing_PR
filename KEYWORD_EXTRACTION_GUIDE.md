# 🔍 KeyBERT 기반 문서 제목 유사도 키워드 추출 가이드

## 🎯 기능

- **KeyBERT 기반 의미적 키워드 추출**: 문서 제목 기준 유사도 기반 키워드 추출
- **문서 제목 키워드 우선 추출**: 문서 제목의 키워드와 유사도가 높은 것을 우선으로 추출
- **반드시 5개 키워드 보장**: 모든 청크에서 정확히 5개의 키워드가 추출됨을 보장
- **추가 키워드 추출**: 제목 키워드와 유사하지 않아도 의미 있는 단어들을 추출하여 5개 채움
- **문서 제목 유사도 계산**: 코사인 유사도를 사용한 의미적 유사도 계산
- **1-3그램 키워드**: 단일 단어, 2단어, 3단어 조합 키워드 추출
- **고정 설정**: chunk_size=500, chunk_overlap=100, 키워드 개수=5개로 고정
- **자동 필드 추가**: 기존 JSON 구조에 `keywords` 필드 자동 추가
- **Fallback 시스템**: KeyBERT 실패 시 기본 키워드 추출로 대체

## 📦 설치

```bash
pip install keybert sentence-transformers scikit-learn
```

## 🚀 사용법

### 기본 사용법

```python
from keyword_extractor import KeywordExtractor

# 키워드 추출기 초기화
extractor = KeywordExtractor()

# 키워드 추출 (문서 제목 기준 유사도)
keywords = extractor.extract_keywords_with_title_similarity(
    text="추출할 텍스트",
    document_title="문서 제목",
    top_k=5
)
```

### 고정 설정

- **chunk_size**: 500 (고정)
- **chunk_overlap**: 100 (고정)
- **키워드 개수**: 5개 (고정)
- **키워드 추출**: 항상 활성화

## 🔧 알고리즘

### 1단계: 문서 제목 키워드 추출
- 문서 제목에서 핵심 키워드 10개 추출
- KeyBERT를 사용한 의미적 키워드 추출

### 2단계: 텍스트 키워드 후보 생성
- KeyBERT로 1-3그램 키워드 50개 생성
- 다양성 보장 (diversity=0.9)

### 3단계: 유사도 계산 및 우선순위 부여
- 키워드와 문서 제목의 의미적 유사도 계산
- 문서 제목 키워드와의 직접 매칭 점수 계산
- 최종 점수 = 유사도 + (제목 키워드 매칭 점수 × 0.5)

### 4단계: 우선순위 키워드 선택
- 최종 점수 기준으로 정렬
- 우선순위가 높은 키워드들 먼저 선택

### 5단계: 추가 키워드 추출 (5개 보장)
- 만약 5개가 안 되면 추가 키워드 추출
- 단어 빈도 기반 의미 있는 단어 추출
- 의료 관련 키워드 사전에서 추가 키워드 검색
- 불용어 제거 및 중복 방지
- **반드시 5개 키워드 보장**

### 키워드 추출 파라미터
- `keyphrase_ngram_range=(1, 3)`: 1-3단어 조합
- `top_k=50`: 키워드 후보 생성 (유사도 계산용)
- `diversity=0.9`: 키워드 다양성 보장
- `document_title`: 문서 제목 (유사도 계산 기준)
- `final_top_k=5`: 최종 상위 5개 키워드 (반드시 보장)
- `stop_words`: 한국어 불용어 리스트
- `medical_keywords`: 확장된 의료 관련 키워드 사전 (80개 이상)

## 🧪 테스트

### 테스트 실행

```bash
python test_keybert_title_similarity.py
```

### 테스트 결과 예시

```
🧪 KeyBERT 기반 문서 제목 유사도 키워드 추출 테스트 (반드시 5개 보장)
📋 문서 제목: 의료기기 GMP 시정 및 예방조치 항목 심사 지침

📋 키워드 추출 결과 (반드시 5개 보장):

[1] 텍스트: 정기적인 PSUR은 허가 후 안전성 정보 수집 및 평가를 위해...
   키워드 개수: 5개
   키워드: ['PSUR', '안전성', '정보', '보고', '허가']
   ✅ 성공: 정확히 5개 키워드 추출됨

[2] 텍스트: 매우 짧은 텍스트입니다.
   키워드 개수: 5개
   키워드: ['의료기기', 'GMP', '시정', '예방조치', '심사']
   ✅ 성공: 정확히 5개 키워드 추출됨

📊 통계:
   총 청크 수: 5
   성공적으로 5개 키워드 추출된 청크: 5
   성공률: 100.0%
```

### 입력 예시

```json
[
  {
    "id": "chunk-3.1-1",
    "text": "정기적인 PSUR은 허가 후 안전성 정보 수집 및 평가를 위해 제출되어야 하며, 의약품의 안전성 프로파일을 지속적으로 모니터링하는 중요한 도구입니다.",
    "metadata": {
      "heading": "의료기기 GMP 시정 및 예방조치 항목 심사 지침",
      "section_id": "3.1",
      "page": 5,
      "chunk_index": 1
    }
  }
]
```

### 추출된 키워드 (문서 제목 기준 유사도)
```
["GMP", "시정조치", "예방조치", "의료기기", "심사"]
```

**문서 제목**: "의료기기 GMP 시정 및 예방조치 항목 심사 지침"

## 🔧 고급 사용법

### 문서 제목 키워드 우선 추출

```python
# 문서 제목에서 키워드 추출
title_keywords = extractor.extract_title_keywords("의료기기 GMP 시정 및 예방조치 항목 심사 지침")

# 제목 키워드와의 매칭 점수 계산
match_score = extractor.calculate_title_keyword_match("GMP", title_keywords)
```

### 유사도 계산 방법

1. **의미적 유사도**: KeyBERT 임베딩 기반 코사인 유사도
2. **직접 매칭**: 정확한 키워드 매칭 (점수: 1.0)
3. **부분 매칭**: 키워드 포함 관계 (점수: 0.8)
4. **단어 매칭**: 단어 단위 겹침 (점수: 0.6 × 겹침 비율)

## 📊 출력 예시

### 키워드가 추가된 JSON

```json
[
  {
    "id": "chunk-3.1-1",
    "text": "GMP 시정조치 및 예방조치는 제조업체가 품질관리 시스템을 통해 지속적으로 개선하고 위험을 사전에 방지하기 위한 체계적인 접근 방법입니다.",
    "metadata": {
      "heading": "의료기기 GMP 시정 및 예방조치 항목 심사 지침",
      "section_id": "3.1",
      "page": 5,
      "chunk_index": 1
    },
    "keywords": ["GMP", "시정조치", "예방조치", "의료기기", "심사"]
  }
]
```

## 🎯 대시보드 통합

### 고정 설정
- 키워드 추출 설정 UI 제거
- 모든 설정이 고정값으로 자동 적용
- 키워드 포함 JSON 파일만 다운로드 버튼 제공

### 결과 표시
- 키워드 추출 결과 자동 표시
- 키워드 샘플 및 통계 정보 제공
- 문서 제목 기준 유사도 키워드 강조

## 🔍 문제 해결

### KeyBERT 로딩 실패
- Fallback 시스템으로 기본 키워드 추출 사용
- 의료 관련 키워드 사전 기반 추출

### 메모리 부족
- 청크 크기 조정 (현재 500으로 고정)
- 키워드 후보 수 조정 (현재 30개로 고정)

### 성능 최적화
- 배치 처리로 여러 청크 동시 처리
- 캐싱을 통한 중복 계산 방지 